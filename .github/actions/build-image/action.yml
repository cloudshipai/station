name: 'Build Station Deployment Image'
description: 'Build a Docker image from a Station environment or bundle'
branding:
  icon: 'box'
  color: 'green'

inputs:
  source-type:
    description: 'Source type: environment (local dir) or bundle (tar.gz URL)'
    required: true
    default: 'environment'
  
  environment:
    description: 'Environment name (required if source-type=environment)'
    required: false
  
  bundle-url:
    description: 'Bundle URL (required if source-type=bundle)'
    required: false
  
  image-name:
    description: 'Docker image name (e.g., station-production)'
    required: true
  
  image-tag:
    description: 'Docker image tag (e.g., v1.0.0, latest)'
    required: true
    default: 'latest'
  
  registry:
    description: 'Container registry (e.g., ghcr.io)'
    required: false
    default: 'ghcr.io'
  
  registry-username:
    description: 'Registry username'
    required: false
  
  registry-password:
    description: 'Registry password/token'
    required: false
  
  push:
    description: 'Push image to registry'
    required: false
    default: 'false'

outputs:
  image-name:
    description: 'Built image name with tag'
    value: ${{ steps.build.outputs.image-name }}
  
  image-digest:
    description: 'Image digest (SHA256)'
    value: ${{ steps.build.outputs.image-digest }}

runs:
  using: 'composite'
  steps:
    - name: Set up Docker Buildx
      uses: docker/setup-buildx-action@v3
    
    - name: Log in to Container Registry
      if: inputs.push == 'true' && inputs.registry-username != '' && inputs.registry-password != ''
      uses: docker/login-action@v3
      with:
        registry: ${{ inputs.registry }}
        username: ${{ inputs.registry-username }}
        password: ${{ inputs.registry-password }}
    
    - name: Prepare build context
      shell: bash
      run: |
        SOURCE_TYPE="${{ inputs.source-type }}"
        
        if [ "$SOURCE_TYPE" = "bundle" ]; then
          BUNDLE_URL="${{ inputs.bundle-url }}"
          if [ -z "$BUNDLE_URL" ]; then
            echo "âŒ Error: bundle-url required when source-type=bundle"
            exit 1
          fi
          
          echo "ðŸ“¦ Downloading bundle: $BUNDLE_URL"
          mkdir -p /tmp/station-bundle
          curl -fsSL "$BUNDLE_URL" -o /tmp/station-bundle/bundle.tar.gz
          
          echo "ðŸ“‚ Extracting bundle..."
          cd /tmp/station-bundle
          tar -xzf bundle.tar.gz
          rm bundle.tar.gz
          
          echo "BUILD_CONTEXT=/tmp/station-bundle" >> $GITHUB_ENV
          
        elif [ "$SOURCE_TYPE" = "environment" ]; then
          ENV_NAME="${{ inputs.environment }}"
          if [ -z "$ENV_NAME" ]; then
            echo "âŒ Error: environment required when source-type=environment"
            exit 1
          fi
          
          if [ ! -d "./environments/$ENV_NAME" ]; then
            echo "âŒ Error: Environment directory not found: ./environments/$ENV_NAME"
            exit 1
          fi
          
          echo "BUILD_CONTEXT=./environments/$ENV_NAME" >> $GITHUB_ENV
        else
          echo "âŒ Error: Invalid source-type: $SOURCE_TYPE (must be 'environment' or 'bundle')"
          exit 1
        fi
    
    - name: Create Dockerfile
      shell: bash
      run: |
        cat > /tmp/Dockerfile.station <<'EOF'
        FROM ghcr.io/cloudshipai/station:latest
        
        # Copy environment configuration
        COPY . /home/station/.config/station/environments/runtime/
        
        # Set working directory
        WORKDIR /home/station/.config/station
        
        # Set environment variables
        ENV STATION_ENV=runtime
        ENV STATION_MODE=production
        
        # Expose ports
        EXPOSE 8585 2222 8587
        
        # Health check
        HEALTHCHECK --interval=30s --timeout=10s --start-period=5s --retries=3 \
          CMD stn status || exit 1
        
        # Run Station server
        CMD ["stn", "up"]
        EOF
        
        echo "ðŸ“ Dockerfile created"
    
    - name: Build Docker image
      id: build
      shell: bash
      run: |
        IMAGE_NAME="${{ inputs.image-name }}"
        IMAGE_TAG="${{ inputs.image-tag }}"
        REGISTRY="${{ inputs.registry }}"
        
        # Build full image name
        if [ "${{ inputs.push }}" = "true" ] && [ -n "$REGISTRY" ]; then
          FULL_IMAGE="${REGISTRY}/${IMAGE_NAME}:${IMAGE_TAG}"
        else
          FULL_IMAGE="${IMAGE_NAME}:${IMAGE_TAG}"
        fi
        
        echo "ðŸ”¨ Building Docker image: $FULL_IMAGE"
        
        docker buildx build \
          --file /tmp/Dockerfile.station \
          --tag "$FULL_IMAGE" \
          --load \
          "$BUILD_CONTEXT"
        
        # Get image digest
        IMAGE_DIGEST=$(docker inspect --format='{{index .RepoDigests 0}}' "$FULL_IMAGE" 2>/dev/null || echo "none")
        
        echo "âœ… Image built: $FULL_IMAGE"
        echo "   Digest: $IMAGE_DIGEST"
        
        echo "image-name=$FULL_IMAGE" >> $GITHUB_OUTPUT
        echo "image-digest=$IMAGE_DIGEST" >> $GITHUB_OUTPUT
    
    - name: Push to registry
      if: inputs.push == 'true'
      shell: bash
      run: |
        IMAGE_NAME="${{ steps.build.outputs.image-name }}"
        
        echo "ðŸ“¤ Pushing image: $IMAGE_NAME"
        docker push "$IMAGE_NAME"
        echo "âœ… Image pushed successfully"
