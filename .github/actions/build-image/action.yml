name: 'Build Station Docker Image'
description: 'Build a Docker image from a Station environment or bundle'
branding:
  icon: 'box'
  color: 'green'

inputs:
  source-type:
    description: 'Source type: environment (local dir) or bundle (tar.gz URL/CloudShip ID)'
    required: false
    default: 'environment'

  environment:
    description: 'Environment name (required if source-type=environment)'
    required: false
    default: 'default'

  bundle-url:
    description: 'Bundle URL (required if source-type=bundle and bundle-id not set)'
    required: false

  bundle-id:
    description: 'CloudShip bundle ID (UUID). Alternative to bundle-url'
    required: false

  cloudship-api-key:
    description: 'CloudShip API key for downloading bundles by ID'
    required: false

  image-name:
    description: 'Docker image name (e.g., my-org/station-production)'
    required: true

  image-tag:
    description: 'Docker image tag (e.g., v1.0.0, latest)'
    required: false
    default: 'latest'

  registry:
    description: 'Container registry (e.g., ghcr.io, docker.io)'
    required: false
    default: 'ghcr.io'

  registry-username:
    description: 'Registry username'
    required: false

  registry-password:
    description: 'Registry password/token'
    required: false

  push:
    description: 'Push image to registry after building'
    required: false
    default: 'false'

  platforms:
    description: 'Target platforms (e.g., linux/amd64,linux/arm64)'
    required: false
    default: 'linux/amd64'

outputs:
  image-name:
    description: 'Built image name with tag'
    value: ${{ steps.build.outputs.image-name }}

  image-digest:
    description: 'Image digest (SHA256)'
    value: ${{ steps.build.outputs.image-digest }}

runs:
  using: 'composite'
  steps:
    - name: Set up Docker Buildx
      uses: docker/setup-buildx-action@v3

    - name: Log in to Container Registry
      if: inputs.push == 'true' && inputs.registry-username != '' && inputs.registry-password != ''
      uses: docker/login-action@v3
      with:
        registry: ${{ inputs.registry }}
        username: ${{ inputs.registry-username }}
        password: ${{ inputs.registry-password }}

    - name: Prepare build context
      id: prepare
      shell: bash
      env:
        SOURCE_TYPE: ${{ inputs.source-type }}
        BUNDLE_URL: ${{ inputs.bundle-url }}
        BUNDLE_ID: ${{ inputs.bundle-id }}
        CLOUDSHIP_API_KEY: ${{ inputs.cloudship-api-key }}
        ENVIRONMENT: ${{ inputs.environment }}
      run: |
        if [ "$SOURCE_TYPE" = "bundle" ]; then
          # Download bundle
          mkdir -p /tmp/station-bundle

          if [ -n "$BUNDLE_ID" ]; then
            # Download from CloudShip by bundle ID
            if [ -z "$CLOUDSHIP_API_KEY" ]; then
              echo "âŒ Error: cloudship-api-key required when using bundle-id"
              exit 1
            fi

            CLOUDSHIP_API_URL="${CLOUDSHIP_API_URL:-https://api.cloudshipai.com}"
            DOWNLOAD_URL="${CLOUDSHIP_API_URL}/api/public/bundles/${BUNDLE_ID}/download/"

            echo "ðŸ“¦ Downloading bundle from CloudShip: $BUNDLE_ID"
            HTTP_CODE=$(curl -sS -w "%{http_code}" \
              -H "X-Registration-Key: ${CLOUDSHIP_API_KEY}" \
              -o /tmp/station-bundle/bundle.tar.gz \
              "$DOWNLOAD_URL")

            if [ "$HTTP_CODE" != "200" ]; then
              echo "âŒ Error: CloudShip API error (HTTP $HTTP_CODE)"
              exit 1
            fi

          elif [ -n "$BUNDLE_URL" ]; then
            echo "ðŸ“¦ Downloading bundle: $BUNDLE_URL"
            curl -fsSL "$BUNDLE_URL" -o /tmp/station-bundle/bundle.tar.gz
          else
            echo "âŒ Error: bundle-url or bundle-id required when source-type=bundle"
            exit 1
          fi

          echo "ðŸ“‚ Extracting bundle..."
          cd /tmp/station-bundle
          tar -xzf bundle.tar.gz
          rm bundle.tar.gz

          echo "build_context=/tmp/station-bundle" >> $GITHUB_OUTPUT

        elif [ "$SOURCE_TYPE" = "environment" ]; then
          ENV_PATH="./environments/$ENVIRONMENT"
          if [ ! -d "$ENV_PATH" ]; then
            echo "âŒ Error: Environment not found: $ENV_PATH"
            exit 1
          fi
          echo "ðŸ“‚ Using environment: $ENVIRONMENT"
          echo "build_context=$ENV_PATH" >> $GITHUB_OUTPUT
        else
          echo "âŒ Error: Invalid source-type: $SOURCE_TYPE"
          exit 1
        fi

    - name: Create Dockerfile
      shell: bash
      run: |
        cat > /tmp/Dockerfile.station <<'EOF'
        FROM ghcr.io/cloudshipai/station:latest

        # Copy environment/bundle configuration
        COPY . /home/station/.config/station/environments/runtime/

        WORKDIR /home/station/.config/station

        ENV STATION_ENV=runtime
        ENV STATION_MODE=production

        EXPOSE 8585 2222 8587

        HEALTHCHECK --interval=30s --timeout=10s --start-period=5s --retries=3 \
          CMD stn status || exit 1

        CMD ["stn", "up"]
        EOF

    - name: Build Docker image
      id: build
      shell: bash
      env:
        BUILD_CONTEXT: ${{ steps.prepare.outputs.build_context }}
      run: |
        IMAGE_NAME="${{ inputs.image-name }}"
        IMAGE_TAG="${{ inputs.image-tag }}"
        REGISTRY="${{ inputs.registry }}"

        # Build full image name
        if [ "${{ inputs.push }}" = "true" ] && [ -n "$REGISTRY" ]; then
          FULL_IMAGE="${REGISTRY}/${IMAGE_NAME}:${IMAGE_TAG}"
        else
          FULL_IMAGE="${IMAGE_NAME}:${IMAGE_TAG}"
        fi

        echo "ðŸ”¨ Building: $FULL_IMAGE"

        docker buildx build \
          --file /tmp/Dockerfile.station \
          --tag "$FULL_IMAGE" \
          --platform "${{ inputs.platforms }}" \
          --load \
          "$BUILD_CONTEXT"

        IMAGE_DIGEST=$(docker inspect --format='{{index .RepoDigests 0}}' "$FULL_IMAGE" 2>/dev/null || echo "local-build")

        echo "âœ… Image built: $FULL_IMAGE"

        echo "image-name=$FULL_IMAGE" >> $GITHUB_OUTPUT
        echo "image-digest=$IMAGE_DIGEST" >> $GITHUB_OUTPUT

    - name: Push to registry
      if: inputs.push == 'true'
      shell: bash
      run: |
        IMAGE_NAME="${{ steps.build.outputs.image-name }}"
        echo "ðŸ“¤ Pushing: $IMAGE_NAME"
        docker push "$IMAGE_NAME"
        echo "âœ… Pushed successfully"
