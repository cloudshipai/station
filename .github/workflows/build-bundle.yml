name: Build and Publish Agent Bundle

on:
  workflow_dispatch:
    inputs:
      environment_name:
        description: 'Environment name to build bundle from (e.g., station-sre, bryan)'
        required: true
        type: string
      bundle_version:
        description: 'Bundle version (e.g., 1.0.0)'
        required: true
        type: string
  push:
    paths:
      - 'bundles/*/template.json'
      - 'bundles/*/agents/**'

jobs:
  build-bundle:
    runs-on: ubuntu-latest
    permissions:
      contents: read
      packages: write
      
    steps:
    - name: Checkout repository
      uses: actions/checkout@v4

    - name: Set up Go
      uses: actions/setup-go@v5
      with:
        go-version: '1.23'

    - name: Build Station CLI
      run: |
        go build -o bin/stn ./cmd/main
        chmod +x bin/stn

    - name: Determine environment to build
      id: env
      run: |
        if [ -n "${{ github.event.inputs.environment_name }}" ]; then
          echo "name=${{ github.event.inputs.environment_name }}" >> $GITHUB_OUTPUT
          echo "version=${{ github.event.inputs.bundle_version }}" >> $GITHUB_OUTPUT
        else
          # Auto-detect from changed files
          ENV_NAME=$(echo "${{ github.event.head_commit.modified }}" | grep -oP 'bundles/\K[^/]+' | head -1)
          echo "name=${ENV_NAME}" >> $GITHUB_OUTPUT
          echo "version=latest" >> $GITHUB_OUTPUT
        fi

    - name: Build bundle from environment
      run: |
        ENV_NAME="${{ steps.env.outputs.name }}"
        VERSION="${{ steps.env.outputs.version }}"
        
        # Create bundle using Station CLI
        ./bin/stn bundle create \
          --env "$ENV_NAME" \
          --output "bundles/${ENV_NAME}-${VERSION}.tar.gz"
        
        echo "Bundle created: bundles/${ENV_NAME}-${VERSION}.tar.gz"
        ls -lh bundles/${ENV_NAME}-${VERSION}.tar.gz

    - name: Generate bundle manifest
      run: |
        ENV_NAME="${{ steps.env.outputs.name }}"
        VERSION="${{ steps.env.outputs.version }}"
        
        cat > "bundles/${ENV_NAME}-${VERSION}.json" <<EOF
        {
          "name": "${ENV_NAME}",
          "version": "${VERSION}",
          "created_at": "$(date -u +%Y-%m-%dT%H:%M:%SZ)",
          "git_commit": "${{ github.sha }}",
          "git_ref": "${{ github.ref }}",
          "download_url": "https://github.com/${{ github.repository }}/releases/download/${VERSION}/${ENV_NAME}-${VERSION}.tar.gz"
        }
        EOF

    - name: Upload bundle artifact
      uses: actions/upload-artifact@v4
      with:
        name: ${{ steps.env.outputs.name }}-${{ steps.env.outputs.version }}
        path: |
          bundles/${{ steps.env.outputs.name }}-${{ steps.env.outputs.version }}.tar.gz
          bundles/${{ steps.env.outputs.name }}-${{ steps.env.outputs.version }}.json
        retention-days: 90

    - name: Create Release (if version tag)
      if: github.event.inputs.bundle_version != ''
      uses: softprops/action-gh-release@v1
      with:
        tag_name: bundle-${{ steps.env.outputs.name }}-${{ steps.env.outputs.version }}
        name: ${{ steps.env.outputs.name }} Bundle v${{ steps.env.outputs.version }}
        files: |
          bundles/${{ steps.env.outputs.name }}-${{ steps.env.outputs.version }}.tar.gz
          bundles/${{ steps.env.outputs.name }}-${{ steps.env.outputs.version }}.json
        body: |
          ## ${{ steps.env.outputs.name }} Agent Bundle
          
          Version: ${{ steps.env.outputs.version }}
          Commit: ${{ github.sha }}
          
          ### Installation
          ```bash
          stn template install https://github.com/${{ github.repository }}/releases/download/bundle-${{ steps.env.outputs.name }}-${{ steps.env.outputs.version }}/${{ steps.env.outputs.name }}-${{ steps.env.outputs.version }}.tar.gz
          ```
      env:
        GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
