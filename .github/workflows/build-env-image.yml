name: Build Environment Container Image

on:
  workflow_dispatch:
    inputs:
      environment_name:
        description: 'Environment name to build image from (e.g., station-sre, bryan)'
        required: true
        type: string
      image_tag:
        description: 'Image tag (e.g., v1.0.0, latest)'
        required: true
        type: string
        default: 'latest'
      push_to_registry:
        description: 'Push to GitHub Container Registry'
        required: false
        type: boolean
        default: true

env:
  REGISTRY: ghcr.io
  IMAGE_PREFIX: cloudshipai/station-env

jobs:
  build-env-image:
    runs-on: ubuntu-latest
    permissions:
      contents: read
      packages: write
      
    steps:
    - name: Checkout repository
      uses: actions/checkout@v4

    - name: Set up Go
      uses: actions/setup-go@v5
      with:
        go-version: '1.23'

    - name: Set up Docker Buildx
      uses: docker/setup-buildx-action@v3

    - name: Build Station CLI
      run: |
        go build -o bin/stn ./cmd/main
        chmod +x bin/stn

    - name: Build environment deployment image
      run: |
        ENV_NAME="${{ github.event.inputs.environment_name }}"
        IMAGE_TAG="${{ github.event.inputs.image_tag }}"
        
        # Build deployment image using stn CLI
        ./bin/stn build env "$ENV_NAME" \
          --skip-sync \
          --tag "$IMAGE_TAG"
        
        echo "Environment image built: station-${ENV_NAME}:${IMAGE_TAG}"
        docker images | grep "station-${ENV_NAME}"

    - name: Tag image for registry
      run: |
        ENV_NAME="${{ github.event.inputs.environment_name }}"
        IMAGE_TAG="${{ github.event.inputs.image_tag }}"
        
        # Tag for GitHub Container Registry
        docker tag "station-${ENV_NAME}:${IMAGE_TAG}" \
          "${{ env.REGISTRY }}/${{ env.IMAGE_PREFIX }}-${ENV_NAME}:${IMAGE_TAG}"
        
        # Also tag as latest if specified
        if [ "$IMAGE_TAG" != "latest" ]; then
          docker tag "station-${ENV_NAME}:${IMAGE_TAG}" \
            "${{ env.REGISTRY }}/${{ env.IMAGE_PREFIX }}-${ENV_NAME}:latest"
        fi

    - name: Log in to Container Registry
      if: github.event.inputs.push_to_registry == 'true'
      uses: docker/login-action@v3
      with:
        registry: ${{ env.REGISTRY }}
        username: ${{ github.actor }}
        password: ${{ secrets.GITHUB_TOKEN }}

    - name: Push to GitHub Container Registry
      if: github.event.inputs.push_to_registry == 'true'
      run: |
        ENV_NAME="${{ github.event.inputs.environment_name }}"
        IMAGE_TAG="${{ github.event.inputs.image_tag }}"
        
        # Push versioned tag
        docker push "${{ env.REGISTRY }}/${{ env.IMAGE_PREFIX }}-${ENV_NAME}:${IMAGE_TAG}"
        
        # Push latest tag if applicable
        if [ "$IMAGE_TAG" != "latest" ]; then
          docker push "${{ env.REGISTRY }}/${{ env.IMAGE_PREFIX }}-${ENV_NAME}:latest"
        fi

    - name: Export image as artifact (if not pushing)
      if: github.event.inputs.push_to_registry != 'true'
      run: |
        ENV_NAME="${{ github.event.inputs.environment_name }}"
        IMAGE_TAG="${{ github.event.inputs.image_tag }}"
        
        # Save image to tar file
        docker save "station-${ENV_NAME}:${IMAGE_TAG}" | gzip > "${ENV_NAME}-${IMAGE_TAG}.tar.gz"

    - name: Upload image artifact
      if: github.event.inputs.push_to_registry != 'true'
      uses: actions/upload-artifact@v4
      with:
        name: ${{ github.event.inputs.environment_name }}-${{ github.event.inputs.image_tag }}
        path: ${{ github.event.inputs.environment_name }}-${{ github.event.inputs.image_tag }}.tar.gz
        retention-days: 30

    - name: Generate deployment instructions
      run: |
        ENV_NAME="${{ github.event.inputs.environment_name }}"
        IMAGE_TAG="${{ github.event.inputs.image_tag }}"
        
        cat > deployment-instructions.md <<EOF
        # Deployment Instructions for ${ENV_NAME}
        
        ## Using Docker Compose
        
        \`\`\`yaml
        services:
          station:
            image: ${{ env.REGISTRY }}/${{ env.IMAGE_PREFIX }}-${ENV_NAME}:${IMAGE_TAG}
            ports:
              - "9686:9686"
            environment:
              - OPENAI_API_KEY=\${OPENAI_API_KEY}
            volumes:
              - station-data:/data
              - station-backups:/backups
        
        volumes:
          station-data:
          station-backups:
        \`\`\`
        
        ## Using Kubernetes
        
        \`\`\`bash
        kubectl create secret generic station-secrets \\
          --from-literal=openai-api-key="\${OPENAI_API_KEY}"
        
        kubectl apply -f - <<EOYAML
        apiVersion: apps/v1
        kind: Deployment
        metadata:
          name: station-${ENV_NAME}
        spec:
          replicas: 1
          selector:
            matchLabels:
              app: station-${ENV_NAME}
          template:
            metadata:
              labels:
                app: station-${ENV_NAME}
            spec:
              containers:
              - name: station
                image: ${{ env.REGISTRY }}/${{ env.IMAGE_PREFIX }}-${ENV_NAME}:${IMAGE_TAG}
                ports:
                - containerPort: 9686
                env:
                - name: OPENAI_API_KEY
                  valueFrom:
                    secretKeyRef:
                      name: station-secrets
                      key: openai-api-key
                volumeMounts:
                - name: data
                  mountPath: /data
              volumes:
              - name: data
                persistentVolumeClaim:
                  claimName: station-data
        EOYAML
        \`\`\`
        
        ## Direct Docker Run
        
        \`\`\`bash
        docker run -d \\
          --name station-${ENV_NAME} \\
          -p 9686:9686 \\
          -e OPENAI_API_KEY=\${OPENAI_API_KEY} \\
          -v station-data:/data \\
          -v station-backups:/backups \\
          ${{ env.REGISTRY }}/${{ env.IMAGE_PREFIX }}-${ENV_NAME}:${IMAGE_TAG}
        \`\`\`
        
        ## Image Details
        
        - **Environment**: ${ENV_NAME}
        - **Tag**: ${IMAGE_TAG}
        - **Built**: $(date -u +"%Y-%m-%d %H:%M:%S UTC")
        - **Commit**: ${{ github.sha }}
        - **Repository**: ${{ github.repository }}
        EOF

    - name: Upload deployment instructions
      uses: actions/upload-artifact@v4
      with:
        name: deployment-instructions-${{ github.event.inputs.environment_name }}
        path: deployment-instructions.md
        retention-days: 90

    - name: Output image details
      run: |
        ENV_NAME="${{ github.event.inputs.environment_name }}"
        IMAGE_TAG="${{ github.event.inputs.image_tag }}"
        
        echo "## Environment Image Built Successfully! ðŸŽ‰" >> $GITHUB_STEP_SUMMARY
        echo "" >> $GITHUB_STEP_SUMMARY
        echo "**Environment**: ${ENV_NAME}" >> $GITHUB_STEP_SUMMARY
        echo "**Image Tag**: ${IMAGE_TAG}" >> $GITHUB_STEP_SUMMARY
        echo "**Registry**: ${{ env.REGISTRY }}/${{ env.IMAGE_PREFIX }}-${ENV_NAME}:${IMAGE_TAG}" >> $GITHUB_STEP_SUMMARY
        echo "" >> $GITHUB_STEP_SUMMARY
        echo "### Quick Deploy" >> $GITHUB_STEP_SUMMARY
        echo "\`\`\`bash" >> $GITHUB_STEP_SUMMARY
        echo "docker run -d -p 9686:9686 -e OPENAI_API_KEY=\${OPENAI_API_KEY} ${{ env.REGISTRY }}/${{ env.IMAGE_PREFIX }}-${ENV_NAME}:${IMAGE_TAG}" >> $GITHUB_STEP_SUMMARY
        echo "\`\`\`" >> $GITHUB_STEP_SUMMARY
