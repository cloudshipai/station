# Fly.io deployment configuration for Station {{.EnvironmentName}}
# Deploy with: fly deploy

app = "station-{{.EnvironmentName}}"
primary_region = "{{.FlyRegion}}"

[build]
  image = "{{.DockerImage}}"

[env]
  STATION_AI_PROVIDER = "{{.AIProvider}}"
  STATION_AI_MODEL = "{{.AIModel}}"
  STATION_API_PORT = "{{.APIPort}}"
  STATION_MCP_PORT = "{{.MCPPort}}"
  STATION_SSH_PORT = "{{.SSHPort}}"
  STATION_DEBUG = "{{.Debug}}"
  STATION_TELEMETRY_ENABLED = "{{.TelemetryEnabled}}"
{{range $key, $value := .EnvironmentVariables}}
  {{$key}} = "{{$value}}"
{{end}}

# Dynamic Agent MCP HTTPS service (agents as tools)
# This is the primary endpoint users should connect to in ChatGPT/Claude Desktop
# Port is MCPPort + 1 (e.g., 8586 + 1 = 8587)
[http_service]
  internal_port = 8587
  force_https = true
  auto_stop_machines = true
  auto_start_machines = true
  min_machines_running = 0
  processes = ["app"]

# Management MCP TCP service (admin tools like add_agent, call_agent)  
[[services]]
  protocol = "tcp"
  internal_port = {{.MCPPort}}
  auto_stop_machines = true
  auto_start_machines = true

  [[services.ports]]
    port = {{.MCPPort}}

[vm]
  cpu_kind = "shared"
  cpus = 1
  memory_mb = 1024

[[mounts]]
  source = "station_data"
  destination = "/data"

# Deployment instructions:
#
# 1. Install Fly.io CLI:
#    curl -L https://fly.io/install.sh | sh
#
# 2. Login to Fly.io:
#    fly auth login
#
# 3. Create the app (first time only):
#    fly apps create station-{{.EnvironmentName}}
#
# 4. Create volume for persistent data:
#    fly volumes create station_data --region {{.FlyRegion}} --size 1
#
# 5. Set API key secret:
#    fly secrets set OPENAI_API_KEY="{{.OpenAIAPIKey}}"
#
# 6. Deploy:
#    fly deploy
#
# 7. Check status:
#    fly status
#    fly logs
#
# 8. Get app URL:
#    fly apps info station-{{.EnvironmentName}}
