# Fly.io deployment configuration for Station {{.EnvironmentName}}
# Deploy with: fly deploy

app = "station-{{.EnvironmentName}}"
primary_region = "{{.FlyRegion}}"

[build]
  image = "{{.DockerImage}}"

[env]
  # AI Configuration - Provider will auto-detect from API keys if not set
  STATION_AI_PROVIDER = "{{.AIProvider}}"
  STATION_AI_MODEL = "{{.AIModel}}"
  
  # Station Service Ports
  STATION_API_PORT = "{{.APIPort}}"
  STATION_MCP_PORT = "{{.MCPPort}}"
  STATION_SSH_PORT = "{{.SSHPort}}"
  
  # Debug and Telemetry
  STATION_DEBUG = "{{.Debug}}"
  STATION_TELEMETRY_ENABLED = "{{.TelemetryEnabled}}"
  
{{range $key, $value := .EnvironmentVariables}}
  {{$key}} = "{{$value}}"
{{end}}

# Secrets Configuration
# Set API keys as Fly secrets (not baked into image or environment variables):
#
#   fly secrets set OPENAI_API_KEY="sk-..." -a station-{{.EnvironmentName}}
#   fly secrets set ANTHROPIC_API_KEY="sk-..." -a station-{{.EnvironmentName}}
#   fly secrets set GEMINI_API_KEY="..." -a station-{{.EnvironmentName}}
#
# Station will auto-detect provider from available API keys if STATION_AI_PROVIDER not set

# Dynamic Agent MCP HTTPS service (agents as tools)
# This is the primary endpoint users should connect to in ChatGPT/Claude Desktop  
# Port is MCPPort + 1 (e.g., 8586 + 1 = 8587)
[http_service]
  internal_port = 8587
  force_https = true
  auto_stop_machines = {{if .FlyAlwaysOn}}false{{else}}true{{end}}
  auto_start_machines = true
  min_machines_running = {{if .FlyAlwaysOn}}1{{else}}0{{end}}
  processes = ["app"]

# Management MCP TCP service (admin tools like add_agent, call_agent)  
[[services]]
  protocol = "tcp"
  internal_port = {{.MCPPort}}
  auto_stop_machines = {{if .FlyAlwaysOn}}false{{else}}true{{end}}
  auto_start_machines = true

  [[services.ports]]
    port = {{.MCPPort}}

[vm]
  cpu_kind = "shared"
  cpus = 1
  memory_mb = 1024

# Stateless deployment - database rebuilt from environment files on each deploy
# For persistence, configure Litestream replication via environment variables

# Deployment instructions:
#
# 1. Install Fly.io CLI:
#    curl -L https://fly.io/install.sh | sh
#
# 2. Login to Fly.io:
#    fly auth login
#
# 3. Create the app (first time only):
#    fly apps create station-{{.EnvironmentName}}
#
# 4. Set API key secret:
#    fly secrets set OPENAI_API_KEY="{{.OpenAIAPIKey}}"
#
# 6. Deploy:
#    fly deploy
#
# 7. Check status:
#    fly status
#    fly logs
#
# 8. Get app URL:
#    fly apps info station-{{.EnvironmentName}}
