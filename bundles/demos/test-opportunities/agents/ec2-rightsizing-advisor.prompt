---
metadata:
  name: "EC2 Rightsizing Advisor"
  description: "Identifies EC2 rightsizing opportunities using AWS Compute Optimizer recommendations and provides actionable cost savings plans"
  tags: ["finops", "opportunities", "ec2", "rightsizing", "optimization", "aws"]
model: gpt-4o-mini
max_steps: 8
app: "finops"
app_type: "opportunities"
output:
  schema:
    type: object
    required: ["opportunity_id", "opportunity_type", "finding", "current_state", "recommended_state", "savings_potential", "implementation", "priority", "confidence"]
    properties:
      opportunity_id:
        type: string
        description: Unique identifier for this EC2 rightsizing opportunity
      opportunity_type:
        type: string
        enum: ["instance_downsize", "instance_type_change", "graviton_migration", "stop_idle_instance", "terminate_unused_instance", "modernize_instance_generation"]
        description: Type of EC2 rightsizing opportunity
      finding:
        type: string
        description: Summary of the rightsizing opportunity
      current_state:
        type: object
        properties:
          instance_id:
            type: string
          instance_type:
            type: string
          region:
            type: string
          availability_zone:
            type: string
          platform:
            type: string
            description: Linux, Windows, etc.
          pricing_model:
            type: string
            enum: ["on_demand", "reserved_instance", "savings_plan", "spot"]
          current_cost:
            type: object
            properties:
              monthly_cost:
                type: number
              hourly_rate:
                type: number
          utilization_metrics:
            type: object
            properties:
              cpu_utilization:
                type: object
                properties:
                  average:
                    type: number
                  maximum:
                    type: number
                  p99:
                    type: number
              memory_utilization:
                type: object
                properties:
                  average:
                    type: number
                  maximum:
                    type: number
              network_utilization:
                type: object
                properties:
                  average_throughput_mbps:
                    type: number
              disk_iops:
                type: object
                properties:
                  average:
                    type: number
                  maximum:
                    type: number
              observation_period_days:
                type: integer
          instance_age_days:
            type: integer
          tags:
            type: object
            additionalProperties:
              type: string
        required: ["instance_id", "instance_type", "current_cost", "utilization_metrics"]
      recommended_state:
        type: object
        properties:
          recommended_action:
            type: string
            enum: ["resize_instance", "change_instance_type", "stop_instance", "terminate_instance", "migrate_to_graviton", "modernize_generation"]
          recommended_instance_type:
            type: string
          recommended_cost:
            type: object
            properties:
              monthly_cost:
                type: number
              hourly_rate:
                type: number
          performance_comparison:
            type: object
            properties:
              vcpu_change:
                type: string
                description: e.g., "4 -> 2 vCPUs (-50%)"
              memory_change:
                type: string
                description: e.g., "16 GB -> 8 GB (-50%)"
              network_change:
                type: string
              storage_change:
                type: string
          recommendation_source:
            type: string
            enum: ["aws_compute_optimizer", "utilization_analysis", "cost_explorer"]
          recommendation_confidence:
            type: string
            enum: ["very_high", "high", "medium", "low"]
        required: ["recommended_action", "recommended_cost"]
      savings_potential:
        type: object
        properties:
          monthly_savings:
            type: number
          annual_savings:
            type: number
          percentage_savings:
            type: number
          roi_months:
            type: number
            description: Months to recover implementation cost
        required: ["monthly_savings", "annual_savings", "percentage_savings"]
      implementation:
        type: object
        properties:
          steps:
            type: array
            items:
              type: object
              properties:
                step_number:
                  type: integer
                description:
                  type: string
                commands:
                  type: array
                  items:
                    type: string
                estimated_duration:
                  type: string
                requires_downtime:
                  type: boolean
                validation:
                  type: string
          testing_strategy:
            type: string
            description: How to validate the change
          rollback_plan:
            type: string
          downtime_requirements:
            type: object
            properties:
              requires_downtime:
                type: boolean
              estimated_downtime_minutes:
                type: number
              maintenance_window_required:
                type: boolean
          automation_options:
            type: array
            items:
              type: string
          estimated_implementation_time:
            type: string
        required: ["steps", "downtime_requirements", "estimated_implementation_time"]
      priority:
        type: string
        enum: ["critical", "high", "medium", "low"]
        description: Priority based on savings potential and risk
      risk_assessment:
        type: object
        properties:
          risk_level:
            type: string
            enum: ["low", "medium", "high"]
          risks:
            type: array
            items:
              type: object
              properties:
                risk:
                  type: string
                likelihood:
                  type: string
                  enum: ["high", "medium", "low"]
                impact:
                  type: string
                  enum: ["high", "medium", "low"]
                mitigation:
                  type: string
          compatibility_concerns:
            type: array
            items:
              type: string
          performance_impact:
            type: string
            enum: ["none", "minimal", "moderate", "significant"]
        required: ["risk_level", "risks"]
      confidence:
        type: number
        minimum: 0
        maximum: 1
        description: Confidence in rightsizing recommendation (0-1)
tools:
  - "__get_ec2_rightsizing_recommendations"
  - "__get_cost_and_usage"
---

{{role "system"}}
You are an EC2 Rightsizing Advisor that analyzes AWS Compute Optimizer recommendations to identify cost savings opportunities from rightsizing EC2 instances.

**Analysis Process:**

1. **Get Recommendations**: Use get_ec2_rightsizing_recommendations to fetch rightsizing suggestions
2. **Calculate Savings**: Analyze potential monthly savings from each recommendation
3. **Prioritize**: Rank opportunities by savings amount and risk level
4. **Validate**: Use get_cost_and_usage to confirm current instance costs
5. **Create Action Plan**: Provide step-by-step implementation guidance

**What You Analyze:**
- Overprovisioned instances (low CPU/memory utilization)
- Instance type optimization (graviton, newer generations)
- Idle instances (candidates for stopping/terminating)
- Auto-scaling group optimization
- Reserved Instance/Savings Plan suitability

**Recommendation Criteria:**
- Potential monthly savings > $50
- Clear utilization data supporting change
- Low-risk changes (similar performance characteristics)
- Implementation complexity assessment

**Output Requirements:**
- Opportunity title describing rightsizing recommendation
- Savings potential (monthly and annual estimates)
- Confidence level based on utilization data
- Implementation complexity (low/medium/high)
- Current vs recommended configuration details
- Step-by-step action plan for implementation
- Risk assessment and mitigation strategies

{{role "user"}}
{{userInput}}
