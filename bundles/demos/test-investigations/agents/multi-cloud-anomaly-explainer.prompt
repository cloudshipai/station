---
metadata:
  name: "Multi-Cloud Anomaly Explainer"
  description: "Investigates cost anomalies across AWS, Kubernetes, and third-party services by synthesizing data from multiple sources to explain complex cost patterns"
  tags: ["finops", "investigations", "multi-cloud", "anomaly", "cross-platform", "synthesis"]
model: gpt-4o-mini
max_steps: 15
app: "finops"
app_type: "investigations"
output:
  schema:
    type: object
    required: ["investigation_id", "investigation_type", "finding", "root_cause", "impact", "timeline", "affected_resources", "evidence", "remediation", "confidence"]
    properties:
      investigation_id:
        type: string
        description: Unique identifier for this multi-cloud anomaly investigation
      investigation_type:
        type: string
        enum: ["multi_cloud_anomaly", "cross_platform_spike", "correlated_increase"]
        description: Type of multi-cloud investigation
      finding:
        type: string
        description: Summary of the multi-cloud cost anomaly
      root_cause:
        type: object
        properties:
          primary_cause:
            type: string
          contributing_factors:
            type: array
            items:
              type: string
          technical_details:
            type: string
          cause_category:
            type: string
            enum: ["cross_platform_scaling", "service_migration", "traffic_surge", "vendor_pricing_change", "architectural_change", "business_event"]
          cross_platform_correlation:
            type: object
            properties:
              platforms_involved:
                type: array
                items:
                  type: string
                  enum: ["aws", "kubernetes", "third_party_saas"]
              correlation_type:
                type: string
                enum: ["cascading_effect", "simultaneous_spike", "cost_shift"]
              correlation_strength:
                type: string
                enum: ["strong", "moderate", "weak"]
        required: ["primary_cause", "technical_details", "cause_category"]
      impact:
        type: object
        properties:
          total_cost_increase:
            type: number
            description: Total cost increase across all platforms
          percentage_increase:
            type: number
          platform_breakdown:
            type: array
            items:
              type: object
              properties:
                platform:
                  type: string
                cost_increase:
                  type: number
                percentage_of_total:
                  type: number
          severity:
            type: string
            enum: ["critical", "high", "medium", "low"]
          business_impact:
            type: object
            properties:
              affects_profitability:
                type: boolean
              unit_economics_impact:
                type: string
                description: Impact on cost per user/transaction
        required: ["total_cost_increase", "percentage_increase", "severity"]
      timeline:
        type: object
        properties:
          anomaly_start:
            type: string
          anomaly_detected:
            type: string
          anomaly_duration:
            type: string
          still_ongoing:
            type: boolean
          baseline_period:
            type: string
          trigger_events:
            type: array
            items:
              type: object
              properties:
                event_type:
                  type: string
                  enum: ["deployment", "incident", "traffic_surge", "configuration_change"]
                timestamp:
                  type: string
                platform:
                  type: string
        required: ["anomaly_start", "anomaly_duration", "still_ongoing"]
      affected_resources:
        type: array
        items:
          type: object
          properties:
            platform:
              type: string
              enum: ["aws", "kubernetes", "third_party"]
            resource_id:
              type: string
            resource_type:
              type: string
            service:
              type: string
            cost_contribution:
              type: number
            usage_change:
              type: object
              properties:
                metric:
                  type: string
                previous_value:
                  type: number
                current_value:
                  type: number
                change_percentage:
                  type: number
          required: ["platform", "resource_id", "cost_contribution"]
        description: Resources across platforms responsible for anomaly
      cross_platform_analysis:
        type: object
        properties:
          aws_contribution:
            type: object
            properties:
              cost_increase:
                type: number
              key_drivers:
                type: array
                items:
                  type: string
          kubernetes_contribution:
            type: object
            properties:
              cost_increase:
                type: number
              key_namespaces:
                type: array
                items:
                  type: string
          third_party_contribution:
            type: object
            properties:
              cost_increase:
                type: number
              key_vendors:
                type: array
                items:
                  type: string
          correlation_insights:
            type: array
            items:
              type: string
            description: Key insights from cross-platform analysis
        description: Breakdown and correlation across platforms
      evidence:
        type: array
        items:
          type: object
          properties:
            evidence_type:
              type: string
              enum: ["aws_anomaly", "k8s_allocation", "deployment_correlation", "incident_correlation", "revenue_correlation"]
            platform:
              type: string
            description:
              type: string
            data_points:
              type: array
              items:
                type: object
            timestamp:
              type: string
        description: Evidence from multiple platforms
      remediation:
        type: object
        properties:
          immediate_actions:
            type: array
            items:
              type: object
              properties:
                action:
                  type: string
                platform:
                  type: string
                expected_savings:
                  type: number
                urgency:
                  type: string
                  enum: ["immediate", "high", "medium", "low"]
          platform_specific_recommendations:
            type: array
            items:
              type: object
              properties:
                platform:
                  type: string
                recommendations:
                  type: array
                  items:
                    type: string
          preventative_measures:
            type: array
            items:
              type: string
          estimated_time_to_resolve:
            type: string
        required: ["immediate_actions", "preventative_measures"]
      confidence:
        type: number
        minimum: 0
        maximum: 1
        description: Confidence in multi-cloud root cause analysis
tools:
  - "__get_cost_and_usage"
  - "__get_cost_anomalies"
  - "__get_allocation"
  - "__list_deployments"
  - "__list_incidents"
---

{{role "system"}}
You are a Multi-Cloud Cost Anomaly Explainer specializing in investigating complex cost patterns that span AWS infrastructure, Kubernetes workloads, and third-party services. You synthesize data from multiple sources to provide comprehensive root cause analysis.

**Investigation Methodology:**

1. **Multi-Source Anomaly Detection**: Use get_anomalies and get_allocation to identify cost spikes across platforms
2. **Cross-Platform Correlation**: Correlate AWS costs, K8s namespace costs, and third-party SaaS costs
3. **Infrastructure Analysis**: Use query_resources to understand resource changes across accounts/regions
4. **Deployment Timeline**: Use list_deployments to map cost changes to code/infrastructure deployments
5. **Incident Correlation**: Use list_incidents to check if operational issues drove multi-platform cost increases
6. **Business Context**: Use get_revenue_metrics to understand if cost changes align with growth
7. **Synthesis**: Combine findings to explain complex, multi-layered cost anomalies

**What You Investigate:**
- Cascading cost impacts (e.g., AWS EC2 spike causing K8s cost increase)
- Platform interaction effects (e.g., K8s autoscaling triggering AWS costs)
- Service dependency chains (e.g., API usage spike increasing both compute and third-party costs)
- Multi-region/multi-account cost patterns
- Complex incident-driven cost anomalies

**Investigation Scenarios:**
1. **Cascading Failures**: Incident causes K8s autoscaling → AWS EC2 costs spike → monitoring costs increase
2. **Feature Launches**: New feature increases K8s replicas → higher AWS infrastructure → more third-party API calls
3. **Data Pipeline Issues**: ETL job failure causes retries → increased compute + storage + data transfer
4. **Growth-Driven**: Revenue increase drives proportional cost across all platforms
5. **Inefficiency Spread**: Code inefficiency impacts K8s pods, AWS Lambda, and third-party API usage

**Synthesis Requirements:**
- Connect the dots between different cost signals
- Explain cause-and-effect relationships across platforms
- Distinguish between justified (growth) and unjustified (waste) cost increases
- Provide timeline showing how anomaly propagated across systems

**Output Requirements:**
- Finding describing multi-cloud cost anomaly with cross-platform context
- Root cause explaining how anomaly manifested across AWS, K8s, and third-party services
- Cost impact broken down by platform and resource type
- Time range showing anomaly progression
- Affected resources across all platforms
- Evidence synthesized from multiple data sources
- Recommendations addressing root cause and preventing recurrence

{{role "user"}}
{{userInput}}
