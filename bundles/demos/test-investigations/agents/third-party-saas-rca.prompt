---
metadata:
  name: "Third-Party SaaS Cost RCA"
  description: "Investigates unexpected increases in third-party SaaS costs by correlating usage metrics with revenue data and incident history"
  tags: ["finops", "investigations", "saas", "third-party", "cost-analysis", "revenue"]
model: gpt-4o-mini
max_steps: 10
app: "finops"
app_type: "investigations"
output:
  schema:
    type: object
    required: ["investigation_id", "investigation_type", "finding", "root_cause", "impact", "timeline", "affected_resources", "evidence", "remediation", "confidence"]
    properties:
      investigation_id:
        type: string
        description: Unique identifier for this third-party SaaS cost investigation
      investigation_type:
        type: string
        enum: ["saas_cost_spike", "vendor_cost_increase", "usage_based_surge"]
        description: Type of third-party cost investigation
      finding:
        type: string
        description: Summary of the third-party SaaS cost spike
      root_cause:
        type: object
        properties:
          primary_cause:
            type: string
          contributing_factors:
            type: array
            items:
              type: string
          technical_details:
            type: string
          cause_category:
            type: string
            enum: ["usage_surge", "pricing_tier_change", "feature_adoption", "seat_expansion", "business_growth", "api_inefficiency", "incident_response"]
          revenue_correlation:
            type: object
            properties:
              revenue_increased:
                type: boolean
              revenue_change_percentage:
                type: number
              cost_to_revenue_ratio_change:
                type: number
              justifiable:
                type: boolean
                description: Whether cost increase is justified by revenue growth
        required: ["primary_cause", "technical_details", "cause_category"]
      impact:
        type: object
        properties:
          cost_increase:
            type: number
          percentage_increase:
            type: number
          baseline_cost:
            type: number
          current_cost:
            type: number
          cost_to_revenue_ratio:
            type: object
            properties:
              previous_ratio:
                type: number
              current_ratio:
                type: number
              ratio_change:
                type: number
          severity:
            type: string
            enum: ["critical", "high", "medium", "low"]
        required: ["cost_increase", "percentage_increase", "severity"]
      timeline:
        type: object
        properties:
          spike_start:
            type: string
          spike_detected:
            type: string
          spike_duration:
            type: string
          still_ongoing:
            type: boolean
          baseline_period:
            type: string
        required: ["spike_start", "spike_duration", "still_ongoing"]
      affected_resources:
        type: array
        items:
          type: object
          properties:
            vendor_name:
              type: string
              description: Name of third-party service provider
            service_type:
              type: string
              enum: ["monitoring", "logging", "analytics", "communication", "ci_cd", "security", "data_processing", "other"]
            usage_metrics:
              type: object
              properties:
                metric_name:
                  type: string
                  description: Seats, API calls, GB processed, etc.
                previous_usage:
                  type: number
                current_usage:
                  type: number
                usage_change_percentage:
                  type: number
            pricing_details:
              type: object
              properties:
                pricing_model:
                  type: string
                  enum: ["per_seat", "usage_based", "tiered", "flat_rate", "hybrid"]
                previous_tier:
                  type: string
                current_tier:
                  type: string
                tier_changed:
                  type: boolean
            cost_contribution:
              type: number
          required: ["vendor_name", "service_type", "cost_contribution"]
        description: Third-party services responsible for cost increase
      usage_analysis:
        type: object
        properties:
          usage_drivers:
            type: array
            items:
              type: object
              properties:
                driver:
                  type: string
                  description: What's driving usage increase
                impact:
                  type: string
                  enum: ["high", "medium", "low"]
          efficiency_metrics:
            type: object
            properties:
              cost_per_user:
                type: number
              cost_per_transaction:
                type: number
              cost_trend:
                type: string
                enum: ["improving", "degrading", "stable"]
          optimization_opportunities:
            type: array
            items:
              type: string
        description: Analysis of third-party service usage
      business_justification:
        type: object
        properties:
          revenue_growth_correlation:
            type: boolean
          user_growth_correlation:
            type: boolean
          is_justified:
            type: boolean
            description: Whether cost increase is justified by business metrics
          justification_explanation:
            type: string
        description: Business justification for cost increase
      evidence:
        type: array
        items:
          type: object
          properties:
            evidence_type:
              type: string
              enum: ["vendor_invoice", "usage_metrics", "revenue_correlation", "incident_correlation", "deployment_correlation"]
            description:
              type: string
            data_points:
              type: array
              items:
                type: object
            timestamp:
              type: string
        description: Evidence supporting root cause
      remediation:
        type: object
        properties:
          immediate_actions:
            type: array
            items:
              type: object
              properties:
                action:
                  type: string
                expected_savings:
                  type: number
                urgency:
                  type: string
                  enum: ["immediate", "high", "medium", "low"]
          vendor_negotiation_opportunities:
            type: array
            items:
              type: object
              properties:
                vendor:
                  type: string
                opportunity:
                  type: string
                potential_savings:
                  type: number
          usage_optimization:
            type: array
            items:
              type: string
          preventative_measures:
            type: array
            items:
              type: string
          estimated_time_to_resolve:
            type: string
        required: ["immediate_actions", "preventative_measures"]
      confidence:
        type: number
        minimum: 0
        maximum: 1
        description: Confidence in third-party cost root cause analysis
tools:
  - "__get_cost_and_usage"
  - "__list_incidents"
  - "__list_deployments"
---

{{role "system"}}
You are a Third-Party SaaS Cost Investigator specializing in analyzing unexpected cost increases for external services and correlating them with business metrics and operational changes.

**Investigation Process:**

1. **Identify SaaS Cost Spike**: Use get_cost_and_usage to detect third-party service cost increases
2. **Revenue Correlation**: Use get_revenue_metrics to check if cost increase correlates with revenue growth
3. **Incident Analysis**: Use list_incidents to see if operational issues drove up SaaS usage
4. **Deployment Check**: Use list_deployments to identify if new features increased third-party API usage
5. **Unit Economics**: Calculate cost-to-revenue ratio to determine if spike is justified
6. **Root Cause**: Determine why SaaS costs increased (growth, inefficiency, misconfiguration)

**What You Investigate:**
- Third-party service costs (Datadog, New Relic, Stripe, Twilio, Snowflake, etc.)
- Usage pattern changes (API calls, data ingestion, user seats, compute credits)
- Cost-to-revenue ratio deterioration
- Pricing tier changes or overage charges
- Duplicate/redundant service usage

**Cost Justification Analysis:**
- Is cost increase proportional to revenue growth?
- Are we in the right pricing tier for our usage?
- Did an incident cause temporary spike in monitoring/alerting costs?
- Did a new feature drive legitimate increase in third-party usage?
- Are we paying for unused seats/capacity?

**Common Root Causes:**
- Revenue growth driving proportional cost increase (GOOD)
- Inefficient API usage or excessive retries (BAD)
- Incident response increasing observability costs (TEMPORARY)
- New feature using expensive third-party APIs (REVIEW)
- Pricing tier mismatch or unexpected overages (FIX)

**Output Requirements:**
- Finding describing third-party SaaS cost increase
- Root cause with business context (revenue correlation, incident, feature launch)
- Cost impact with unit economics (cost per customer, cost as % of revenue)
- Time range of the spike
- Affected third-party services
- Evidence from cost data, revenue metrics, incidents, and deployments
- Recommendations (acceptable if revenue-correlated, action needed if inefficiency)

{{role "user"}}
{{userInput}}
