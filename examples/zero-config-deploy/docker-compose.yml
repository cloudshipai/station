services:
  station:
    image: station:local
    container_name: station-zero-config
    ports:
      - "8585:8585"  # API/UI port
      - "8586:8586"  # MCP port
    environment:
      # AI Provider Configuration (required)
      - OPENAI_API_KEY=${OPENAI_API_KEY}

      # CloudShip Configuration (v2 auth flow)
      - STN_CLOUDSHIP_ENABLED=${STN_CLOUDSHIP_ENABLED:-true}
      - STN_CLOUDSHIP_ENDPOINT=${STN_CLOUDSHIP_ENDPOINT:-lighthouse.cloudshipai.com:443}
      - STN_CLOUDSHIP_KEY=${STN_CLOUDSHIP_KEY}
      - STN_CLOUDSHIP_USE_TLS=${STN_CLOUDSHIP_USE_TLS:-true}
      - STN_CLOUDSHIP_NAME=${STN_CLOUDSHIP_NAME:-docker-station}
      - STN_CLOUDSHIP_API_URL=${STN_CLOUDSHIP_API_URL:-https://app.cloudshipai.com}

      # Bundle auto-download (set STN_BUNDLE_ID to a bundle UUID to auto-install)
      - STN_BUNDLE_ID=${STN_BUNDLE_ID:-}

      # Telemetry Configuration (traces to CloudShip)
      - STN_TELEMETRY_ENABLED=${STN_TELEMETRY_ENABLED:-true}
    volumes:
      # Persist Station data
      - station-data:/root/.config/station
    entrypoint: ["/bin/sh", "-c"]
    command:
      - |
        echo 'üöÄ Station Zero-Config Deployment Starting...'
        
        if [ ! -f /root/.config/station/config.yaml ]; then
          echo 'üì¶ Initializing Station...'
          stn init --provider openai --model gpt-4o-mini --yes
        fi
        
        echo 'üåê Starting Station server...'
        exec stn serve
    restart: unless-stopped
    healthcheck:
      test: ["CMD", "curl", "-f", "http://localhost:8585/health"]
      interval: 30s
      timeout: 10s
      retries: 3
      start_period: 40s

volumes:
  station-data:
    driver: local
