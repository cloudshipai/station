---
- name: Deploy Station (Centralized NATS Mode)
  hosts: orchestrator
  become: yes
  vars_files:
    - vars/main.yml
  
  tasks:
    - name: Create station directories
      file:
        path: "{{ item }}"
        state: directory
        owner: '1000'
        group: '1000'
        mode: '0755'
      loop:
        - "{{ station_install_dir }}"
        - "{{ station_data_dir }}"
        - "{{ station_data_dir }}/environments/default"
    
    - name: Deploy station config.yaml
      copy:
        src: files/config.yaml
        dest: "{{ station_data_dir }}/config.yaml"
        owner: '1000'
        group: '1000'
        mode: '0644'
      notify: Restart Station
    
    - name: Deploy docker-compose.yml
      template:
        src: templates/docker-compose.yml.j2
        dest: "{{ station_install_dir }}/docker-compose.yml"
        owner: root
        group: root
        mode: '0644'
      notify: Restart Station
    
    - name: Pull Station image
      shell: docker pull {{ station_image }}
      register: pull_result
      changed_when: "'Downloaded' in pull_result.stdout or 'Pull complete' in pull_result.stdout"
    
    - name: Start Station container
      shell: |
        cd {{ station_install_dir }}
        docker compose up -d
      register: compose_result
      changed_when: "'Started' in compose_result.stdout or 'Creating' in compose_result.stdout"
    
    - name: Wait for Station to be ready
      uri:
        url: "http://localhost:{{ station_dynamic_mcp_port }}/health"
        status_code: 200
      register: result
      until: result.status == 200
      retries: 30
      delay: 2
      ignore_errors: yes
    
    - name: Display Station info
      debug:
        msg: |
          Station deployed in centralized NATS mode!
          - MCP Port: {{ station_mcp_port }}
          - Connected to NATS: nats://{{ nats_server_ip }}:4222
          - Station Name: {{ station_env.STN_LATTICE_STATION_NAME }}
  
  handlers:
    - name: Restart Station
      shell: |
        cd {{ station_install_dir }}
        docker compose down
        docker compose up -d
