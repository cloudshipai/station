pipeline {
  agent {
    docker {
      image 'ghcr.io/cloudshipai/station:latest'
      args '-v /var/run/docker.sock:/var/run/docker.sock'
    }
  }

  environment {
    OPENAI_API_KEY = credentials('openai-api-key')
  }

  stages {
    stage('Code Review') {
      when {
        anyOf {
          branch 'main'
          changeRequest()
        }
      }
      steps {
        sh 'stn agent run "Code Reviewer" "Review code for bugs and best practices"'
      }
    }

    stage('Security Scan') {
      steps {
        sh 'stn agent run "Security Analyst" "Scan for security vulnerabilities"'
      }
    }
  }

  post {
    always {
      echo 'Station analysis completed'
    }
  }
}
